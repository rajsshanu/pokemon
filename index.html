<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Retro Pok√©mon Personality Quiz ‚Äî Card Download Fix</title>

  <!-- Pixel font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">

  <!-- html2canvas library for card download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* Original Quiz Styles */
    :root {
      --gc-purple: #663399;
      --gc-silver: #b8bcc8;
      --gc-dark: #2a1810;
      --gc-orange: #ff6600;
      --screen-bg: #1a1a2e;
      --screen-glow: #4a69bd;
      --text-light: #e8e8e8;
      --text-dark: #0f0f23;
      --accent: #ff6b35;
      --accent-dark: #cc5529;
      --button-gray: #6c7b7f;
      --button-light: #9ca3af;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: radial-gradient(circle at 50% 50%, #1a1a2e, #16213e, #0f3460);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Press Start 2P', monospace;
      color: var(--text-light);
      min-height: 100vh;
      padding: 1rem 0;
      /* Add some padding for smaller viewports */
    }

    .gamecube {
      /* RESPONSIVE: Use max-width and a percentage width */
      max-width: 820px;
      width: 95%;
      background: linear-gradient(145deg, var(--gc-purple) 0%, #5a2d91 35%, #4a2570 100%);
      border: 8px solid var(--gc-silver);
      border-radius: 25px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.8), inset 0 4px 8px rgba(255, 255, 255, 0.1), inset 0 -4px 8px rgba(0, 0, 0, 0.3);
      padding: 25px;
      position: relative;
      overflow: hidden;
    }

    .console-header {
      text-align: center;
      margin-bottom: 20px;
      padding: 12px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.1));
      border-radius: 15px;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .console-logo {
      color: var(--gc-orange);
      font-size: 14px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
      letter-spacing: 2px;
    }

    .gaming-area {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .main-screen {
      /* RESPONSIVE: Allow screen to grow and shrink */
      flex: 1;
      min-width: 0;
      background: linear-gradient(145deg, var(--screen-bg), #16213e);
      border: 6px solid var(--gc-silver);
      border-radius: 20px;
      padding: 18px;
      min-height: 320px;
      box-shadow: inset 0 8px 16px rgba(0, 0, 0, 0.6), inset 0 0 20px rgba(74, 105, 189, 0.1), 0 0 30px rgba(74, 105, 189, 0.3);
      position: relative;
      overflow: hidden;
    }

    .main-screen::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, rgba(74, 105, 189, 0.3), rgba(255, 107, 53, 0.2), rgba(74, 105, 189, 0.3));
      border-radius: 20px;
      z-index: -1;
      animation: screenGlow 3s ease-in-out infinite alternate;
    }

    @keyframes screenGlow {
      0% {
        opacity: 0.3;
      }

      100% {
        opacity: 0.7;
      }
    }

    .dialog {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
      border: 3px solid rgba(74, 105, 189, 0.4);
      border-radius: 12px;
      padding: 16px;
      min-height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 11px;
      color: var(--text-light);
      box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.1), 0 4px 8px rgba(0, 0, 0, 0.3);
      line-height: 1.6;
    }

    .options {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .option-btn {
      width: 92%;
      background: linear-gradient(145deg, var(--button-gray), var(--button-light));
      color: var(--text-dark);
      border: 3px solid var(--gc-silver);
      border-radius: 12px;
      padding: 10px 8px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: center;
      user-select: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.3);
      position: relative;
    }

    .option-btn:hover {
      transform: translateY(-3px);
      background: linear-gradient(145deg, var(--accent), var(--accent-dark));
      color: var(--text-light);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.2);
    }

    .option-btn:active {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .name-input {
      width: 92%;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      color: var(--text-light);
      border: 3px solid var(--gc-silver);
      border-radius: 12px;
      padding: 10px 8px;
      font-size: 10px;
      text-align: center;
      font-family: 'Press Start 2P', monospace;
      margin: 8px 0;
      box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(74, 105, 189, 0.3);
    }

    .name-input::placeholder {
      color: rgba(232, 232, 232, 0.5);
    }

    .name-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.4), 0 0 12px rgba(255, 107, 53, 0.5);
    }

    .controller-panel {
      width: 160px;
      /* Slightly wider for balance */
      flex-shrink: 0;
      /* Prevent panel from shrinking */
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    .power-indicator {
      width: 100%;
      height: 30px;
      background: linear-gradient(90deg, var(--gc-orange), #ff8533);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 8px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.2);
      animation: powerPulse 2s ease-in-out infinite alternate;
    }

    @keyframes powerPulse {
      0% {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.2);
      }

      100% {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.2), 0 0 20px rgba(255, 102, 0, 0.6);
      }
    }

    .preview-slot {
      width: 100%;
      height: 140px;
      background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
      border: 4px solid var(--gc-silver);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      box-shadow: inset 0 6px 12px rgba(0, 0, 0, 0.5), 0 4px 8px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .preview-slot::before {
      content: '';
      position: absolute;
      top: 5px;
      left: 5px;
      right: 5px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(74, 105, 189, 0.8), transparent);
      animation: scanLine 2s linear infinite;
    }

    @keyframes scanLine {
      0% {
        transform: translateY(0);
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }

      100% {
        transform: translateY(120px);
        opacity: 1;
      }
    }

    .preview-slot img {
      max-width: 100%;
      max-height: 100%;
      image-rendering: pixelated;
      filter: drop-shadow(0 0 10px rgba(74, 105, 189, 0.5));
    }

    .status-display {
      width: 100%;
      background: linear-gradient(145deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.3));
      border: 2px solid var(--gc-silver);
      border-radius: 10px;
      padding: 8px;
      text-align: center;
      font-size: 8px;
      color: var(--text-light);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .typing {
      display: inline-block;
      width: 8px;
      height: 12px;
      background: var(--accent);
      margin-left: 6px;
      vertical-align: middle;
      animation: blink 1s steps(1) infinite;
      box-shadow: 0 0 4px rgba(255, 107, 53, 0.8);
    }

    @keyframes blink {
      50% {
        opacity: 0
      }
    }

    .result-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .result-card {
      width: 100%;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      border: 3px solid rgba(74, 105, 189, 0.6);
      border-radius: 15px;
      padding: 16px;
      text-align: center;
      box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.1), 0 8px 16px rgba(0, 0, 0, 0.3);
    }

    .pokemon-name {
      font-size: 12px;
      color: var(--accent);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }

    .trainer-name {
      font-size: 10px;
      color: var(--text-light);
      margin-bottom: 8px;
      opacity: 0.9;
    }

    .restart {
      background: linear-gradient(145deg, var(--gc-orange), #e55a00);
      color: white;
      border: 3px solid var(--gc-silver);
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.2);
    }

    .restart:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.3);
    }

    .restart:active {
      transform: translateY(0);
    }

    .muted {
      opacity: 0.8;
      font-size: 9px;
      color: var(--text-light);
      margin-top: 8px;
      line-height: 1.5;
    }

    .result-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      align-items: center;
    }

    /* New Holo Card Styles (from card2.html) */
    .holo-card-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      font-family: 'PT Sans', sans-serif;
    }

    .pokemon-card {
      width: 380px;
      height: 530px;
      background: #e6e6e6;
      border: 12px solid #f9d71c;
      border-radius: 20px;
      position: relative;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      transition: transform 0.2s ease-out;
      --mx: 0.5;
      --my: 0.5;
    }

    .card-inner {
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, #d3d3d3 25%, #ff8c00 45%);
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      /* Match outer radius */
    }

    .card-inner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: repeating-radial-gradient(circle at center, rgba(255, 255, 255, 0.2) 0, rgba(255, 255, 255, 0.2) 1px, transparent 1px, transparent 10px);
      background-size: 20px 20px;
      background-position: 0px 0px;
      mask-image: linear-gradient(to bottom, transparent 30%, black 50%);
      -webkit-mask-image: linear-gradient(to bottom, transparent 30%, black 50%);
      z-index: 1;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .card-inner.interactive::before {
      background-position: calc((var(--mx, 0.5) - 0.5) * 40px) calc((var(--my, 0.5) - 0.5) * 40px);
    }

    .card-inner.is-capturing::before {
      background-image: repeating-radial-gradient(circle at center, rgba(255, 255, 255, 0.4) 0, rgba(255, 255, 255, 0.4) 1px, transparent 1px, transparent 8px);
      background-size: 15px 15px;
      background-position: 0 0;
      opacity: 0.8;
      mix-blend-mode: overlay;
    }

    .card-header,
    .image-container,
    .stats-bar,
    .attacks-section,
    .card-footer {
      position: relative;
      z-index: 2;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      font-family: 'PT Sans', sans-serif;
      font-weight: 700;
      color: black;
    }

    .stage-info {
      font-size: 16px;
    }

    .stage-info .evolves-from {
      font-size: 12px;
      font-weight: 400;
      margin-left: 10px;
      font-style: italic;
    }

    .hp-info {
      display: flex;
      align-items: center;
      font-size: 24px;
    }

    .hp-info .hp-text {
      font-size: 12px;
      font-weight: 400;
      margin-right: 2px;
      position: relative;
      top: -5px;
    }

    .energy-symbol {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #ff4500;
      border: 2px solid white;
      margin-left: 5px;
    }

    .image-container {
      width: 85%;
      /* Make slightly wider for better look */
      height: 200px;
      margin: 0 auto;
      border: 4px solid #c0c0c0;
      background-size: cover;
      background-position: center;
    }

    .image-container::before,
    .image-container::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      pointer-events: none;
    }

    .image-container::before {
      background: linear-gradient(135deg, rgba(255, 0, 0, 0.5) 0%, rgba(255, 165, 0, 0.5) 20%, rgba(255, 255, 0, 0.5) 40%, rgba(0, 128, 0, 0.5) 60%, rgba(0, 0, 255, 0.5) 80%, rgba(75, 0, 130, 0.5) 100%);
      mix-blend-mode: hard-light;
    }

    .image-container::after {
      background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.8) 1%, transparent 2%), repeating-radial-gradient(rgba(255, 255, 255, 0.2) 0, rgba(255, 255, 255, 0.2) 1px, transparent 1px, transparent 10px);
      background-size: 40px 40px, 100% 100%;
    }

    .image-container.interactive::after {
      background: radial-gradient(circle at calc(var(--mx, 0.5) * 100%) calc(var(--my, 0.5) * 100%), rgba(255, 255, 255, 0.8) 1%, transparent 2%), repeating-radial-gradient(rgba(255, 255, 255, 0.2) 0, rgba(255, 255, 255, 0.2) 1px, transparent 1px, transparent 10px);
      background-size: 40px 40px, 100% 100%;
    }

    .pokemon-card:hover .image-container::before,
    .pokemon-card:hover .image-container::after {
      opacity: 1;
    }

    .stats-bar {
      background: #c0c0c0;
      text-align: center;
      padding: 2px;
      margin-top: 5px;
      /* Add some space */
      font-size: 12px;
      font-style: italic;
      color: black;
    }

    .attacks-section {
      padding: 10px 15px;
      color: black;
    }

    .ability {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .ability-name {
      font-weight: 700;
      font-size: 18px;
      margin-left: 10px;
    }

    .ability-tag {
      background: #e74c3c;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-weight: 700;
      clip-path: polygon(0% 0%, 85% 0, 100% 50%, 85% 100%, 0% 100%);
    }

    .ability-description,
    .attack-description {
      font-size: 12px;
      margin: 0;
      font-family: 'PT Sans', sans-serif;
    }

    .attack {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }

    .attack-cost {
      display: flex;
      gap: 5px;
    }

    .attack-cost .energy-symbol {
      width: 20px;
      height: 20px;
    }

    .attack-name {
      font-weight: 700;
      font-size: 18px;
      flex-grow: 1;
      margin-left: 10px;
    }

    .attack-damage {
      font-weight: 700;
      font-size: 18px;
    }

    .card-footer {
      position: absolute;
      /* Position at bottom */
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      border-top: 2px solid #c0c0c0;
      font-size: 12px;
      color: black;
    }

    .footer-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-weight: bold;
    }

    .back-button {
      background: linear-gradient(145deg, #6c7b7f, #9ca3af);
      color: #0f0f23;
      border: 3px solid var(--gc-silver);
      border-radius: 12px;
      padding: 10px 16px;
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      cursor: pointer;
      margin-top: 15px;
    }

    .back-button:hover {
      background: linear-gradient(145deg, var(--accent), var(--accent-dark));
      color: white;
    }

    /* =================== */
    /* RESPONSIVE STYLES */
    /* =================== */
    @media (max-width: 850px) {
      body {
        /* Allow body to scroll on small screens */
        height: auto;
      }

      .gamecube {
        padding: 15px;
        border-width: 6px;
      }

      .gaming-area {
        flex-direction: column;
      }

      .main-screen {
        width: 100%;
        min-height: 280px;
        padding: 12px;
        border-width: 4px;
      }

      .controller-panel {
        width: 100%;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
        gap: 10px;
      }

      .power-indicator,
      .status-display {
        flex: 1;
        font-size: 7px;
        padding: 6px;
        height: auto;
      }

      .preview-slot {
        flex: 1.5;
        height: 100px;
      }

      @keyframes scanLine {
        100% {
          transform: translateY(80px);
          opacity: 1;
        }
      }

      .dialog {
        font-size: 10px;
        min-height: 80px;
      }

      .option-btn,
      .name-input,
      .restart,
      .back-button {
        font-size: 9px;
        padding: 8px 12px;
      }

      .console-logo {
        font-size: 11px;
      }

      /* Responsive Holo Card */
      .pokemon-card {
        width: 95%;
        max-width: 380px;
        /* prevent it from getting too big */
        height: auto;
        /* let content define height */
        aspect-ratio: 380 / 530;
        /* maintain aspect ratio */
        border-width: 8px;
        font-size: 14px;
        display: flex;
        flex-direction: column;
      }

      .card-inner {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }

      .card-header,
      .attacks-section {
        padding: 5px 10px;
        flex-shrink: 0;
      }

      .stage-info {
        font-size: 3.5vw;
        max-font-size: 14px;
      }

      .hp-info {
        font-size: 5vw;
        max-font-size: 20px;
      }

      .energy-symbol {
        width: 6vw;
        height: 6vw;
        max-width: 25px;
        max-height: 25px;
      }

      .image-container {
        height: auto;
        flex-grow: 1;
        min-height: 100px;
      }

      .stats-bar,
      .ability-description,
      .attack-description {
        font-size: 2.5vw;
        max-font-size: 11px;
        line-height: 1.3;
      }

      .ability-name,
      .attack-name,
      .attack-damage {
        font-size: 4vw;
        max-font-size: 16px;
      }

      .attack-cost .energy-symbol {
        width: 4vw;
        height: 4vw;
        max-width: 18px;
        max-height: 18px;
      }

      .card-footer {
        position: relative;
        padding: 5px 10px;
      }

      .footer-item {
        font-size: 3vw;
        max-font-size: 12px;
      }
    }
  </style>
</head>

<body>
  <!-- Main Quiz UI -->
  <div class="gamecube" id="gamecube-console" role="application" aria-label="Pokemon personality quiz">
    <div class="console-header">
      <div class="console-logo">‚óà POK√âCUBE QUIZ ‚óà</div>
    </div>

    <div class="gaming-area">
      <div class="main-screen" id="screen">
        <!-- This area is controlled by JS: dialog, options, results -->
        <div id="quiz-content">
          <div class="dialog" id="dialog">Loading...</div>
          <div class="options" id="options"></div>
        </div>
        <!-- This is where the holo card will be displayed -->
        <div class="holo-card-container" id="holo-card-container" style="display: none;">
          <div class="pokemon-card" id="pokemon-card">
            <div class="card-inner">
              <div class="card-header">
                <div class="stage-info" id="card-stage-info"></div>
                <div class="hp-info"><span class="hp-text">HP</span> <span id="card-hp"></span>
                  <div class="energy-symbol" id="card-energy-symbol"></div>
                </div>
              </div>
              <div class="image-container" id="card-image-container"></div>
              <div class="stats-bar" id="card-stats-bar"></div>
              <div class="attacks-section">
                <div class="ability"><span class="ability-tag">Ability</span><span class="ability-name"
                    id="card-ability-name"></span></div>
                <p class="ability-description" id="card-ability-description"></p>
                <div class="attack">
                  <div class="attack-cost">
                    <div class="energy-symbol"></div>
                    <div class="energy-symbol"></div>
                  </div>
                  <span class="attack-name" id="card-attack-name"></span>
                  <span class="attack-damage" id="card-attack-damage"></span>
                </div>
                <p class="attack-description" id="card-attack-description"></p>
              </div>
              <div class="card-footer">
                <div class="footer-item"><span>weakness</span><span id="card-weakness"></span></div>
                <div class="footer-item"><span>resistance</span></div>
                <div class="footer-item"><span>retreat</span><span id="card-retreat"></span></div>
              </div>
            </div>
          </div>
          <button class="back-button" id="back-to-result">Back to Summary</button>
        </div>
      </div>

      <div class="controller-panel">
        <div class="power-indicator">‚óè ONLINE</div>
        <div class="preview-slot" id="preview">
          <img id="preview-img" src="https://play.pokemonshowdown.com/sprites/ani/pikachu.gif" alt="preview">
        </div>
        <div class="status-display" id="status">Welcome, trainer!</div>
      </div>
    </div>
  </div>

  <script>
    /* ============= QUIZ DATA ============= */
    const quizQuestions = [
      { question: "What's your favorite color palette?", options: ["Neon", "Pastal", "Earthy", "Dark tones", "Red", "Blue", "Green", "Yellow", "Orange", "Aqua", "Brown", "Purple"] },
      { question: "Pick your ideal drink:", options: ["Coffee", "Matcha", "Tea", "Juice", "Spicy", "Mild", "Sweet", "Sour"] },
      { question: "What weather do you prefer?", options: ["Sunny", "Rainy", "Cloudy", "Snowy"] },
      { question: "How would you describe your personality?", options: ["Fast", "Calm", "Steady", "Unpredictable"] },
      { question: "Choose your favorite music vibe:", options: ["Rock", "Jazz", "Ambient", "Pop", "Guitar", "Piano", "Flute", "Synthesizer"] },
      { question: "What's your favorite season?", options: ["Summer", "Monsoon", "Spring", "Winter"] },
      { question: "Pick a Pok√©mon item:", options: ["Pok√©ball", "Potion", "Forest", "Rare Candy", "Master Ball", "Berry"] },
      { question: "Choose your ideal environment:", options: ["Mountains", "Ocean", "Meadow", "City", "Volcano", "Waterfall", "Garden", "Skyline", "Laboratory", "Greenhouse"] },
      { question: "Pick your favorite activity:", options: ["Action", "Swimming", "Hiking", "Gaming", "Sprint", "Meditation", "Yoga", "Parkour"] },
      { question: "Choose a mythical creature:", options: ["Dragon", "Dolphin", "Deer", "Tiger", "Phoenix", "Mermaid", "Fairy", "Robot"] },
      { question: "What role suits you best?", options: ["Warrior", "Healer", "Guardian", "Inventor"] },
      { question: "Pick your ideal hangout spot:", options: ["Bonfire", "Lake", "Lightning", "Arcade", "Caf√©", "Greenhouse"] }
    ];

    /* ============ POKEMON CARD DETAILS ============ */
    const pokemonDetails = {
      charizard: { stage: 'STAGE 2', evolvesFrom: 'Evolves from Charmeleon', hp: '170', type: '#ff4500', stats: "NO. 006 Flame Pok√©mon HT: 5'7\" WT: 199.5 lbs.", abilityName: 'Battle Sense', abilityDescription: 'Once during your turn, you may look at the top 3 cards of your deck and put 1 of them into your hand. Discard the other cards.', attackName: 'Royal Blaze', attackDamage: '100+', attackDescription: 'This attack does 50 more damage for each Leon card in your discard pile.', weakness: 'üíß x2', retreat: '‚≠ê ‚≠ê ‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/6.png' },
      blastoise: { stage: 'STAGE 2', evolvesFrom: 'Evolves from Wartortle', hp: '180', type: '#4a90e2', stats: "NO. 009 Shellfish Pok√©mon HT: 5'3\" WT: 188.5 lbs.", abilityName: 'Vitality Spring', abilityDescription: 'Once during your turn, you may search your deck for up to 3 Water Energy cards and attach them to your Pok√©mon in any way you like.', attackName: 'Hydro Pump', attackDamage: '120', attackDescription: 'This attack does 20 more damage for each Water Energy attached.', weakness: '‚ö° x2', retreat: '‚≠ê ‚≠ê ‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/9.png' },
      venusaur: { stage: 'STAGE 2', evolvesFrom: 'Evolves from Ivysaur', hp: '180', type: '#78c850', stats: "NO. 003 Seed Pok√©mon HT: 6'7\" WT: 220.5 lbs.", abilityName: 'Jungle Totem', abilityDescription: 'Your Grass Pok√©mon in play, except for any Venusaur, have no Weakness.', attackName: 'Solar Beam', attackDamage: '120', attackDescription: "This Pok√©mon can't use Solar Beam during your next turn.", weakness: 'üî• x2', retreat: '‚≠ê ‚≠ê ‚≠ê ‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/3.png' },
      pikachu: { stage: 'BASIC', evolvesFrom: '', hp: '60', type: '#f8d030', stats: "NO. 025 Mouse Pok√©mon HT: 1'4\" WT: 13.2 lbs.", abilityName: 'Static', abilityDescription: "If this Pok√©mon is your Active Pok√©mon and is damaged by an opponent's attack, the Attacking Pok√©mon is now Paralyzed.", attackName: 'Thunder Shock', attackDamage: '20', attackDescription: 'Flip a coin. If heads, the Defending Pok√©mon is now Paralyzed.', weakness: 'üêæ x2', retreat: '‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png' },
      alakazam: { stage: 'STAGE 2', evolvesFrom: 'Evolves from Kadabra', hp: '130', type: '#f85888', stats: "NO. 065 Psi Pok√©mon HT: 4'11\" WT: 105.8 lbs.", abilityName: 'Mind Ruler', abilityDescription: "Prevent all effects of your opponent's attacks, except damage, done to your Benched Pok√©mon.", attackName: 'Zen Spoon', attackDamage: '60x', attackDescription: "This attack does 60 damage for each of your opponent's Benched Pok√©mon.", weakness: 'üêæ x2', retreat: '‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/65.png' },
      articuno: { stage: 'BASIC', evolvesFrom: '', hp: '120', type: '#98d8d8', stats: "NO. 144 Freeze Pok√©mon HT: 5'7\" WT: 122.1 lbs.", abilityName: 'Ice Wing', abilityDescription: "Discard a Water Energy from this Pok√©mon. The Defending Pok√©mon can't attack during your opponent's next turn.", attackName: 'Blizzard', attackDamage: '110', attackDescription: "This attack does 10 damage to each of your opponent's Benched Pok√©mon.", weakness: '‚öôÔ∏è x2', retreat: '‚≠ê ‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/144.png' },
      onix: { stage: 'BASIC', evolvesFrom: '', hp: '120', type: '#e0c068', stats: "NO. 095 Rock Snake Pok√©mon HT: 28'10\" WT: 463.0 lbs.", abilityName: 'Sturdy', abilityDescription: 'If this Pok√©mon has full HP and would be Knocked Out by damage from an attack, it is not Knocked Out and its remaining HP becomes 10.', attackName: 'Rock Slide', attackDamage: '80', attackDescription: "This attack does 20 damage to 2 of your opponent's Benched Pok√©mon.", weakness: 'üåø x2', retreat: '‚≠ê ‚≠ê ‚≠ê ‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/95.png' },
      umbreon: { stage: 'STAGE 1', evolvesFrom: 'Evolves from Eevee', hp: '110', type: '#2a1810', stats: "NO. 197 Moonlight Pok√©mon HT: 3'3\" WT: 59.5 lbs.", abilityName: 'Dark Signal', abilityDescription: "When you play this Pok√©mon from your hand to evolve 1 of your Pok√©mon, you may switch 1 of your opponent's Benched Pok√©mon with their Active Pok√©mon.", attackName: 'Mean Look', attackDamage: '70', attackDescription: "The Defending Pok√©mon can't retreat during your opponent's next turn.", weakness: 'üåø x2', retreat: '‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/197.png' },
      gardevoir: { stage: 'STAGE 2', evolvesFrom: 'Evolves from Kirlia', hp: '140', type: '#f098a8', stats: "NO. 282 Embrace Pok√©mon HT: 5'3\" WT: 106.7 lbs.", abilityName: 'Shining Arcana', abilityDescription: 'Once during your turn, you may look at the top 2 cards of your deck and attach any number of basic Energy cards you find there to your Pok√©mon in any way you like.', attackName: 'Brain Wave', attackDamage: '60+', attackDescription: 'This attack does 30 more damage for each Psychic Energy attached to this Pok√©mon.', weakness: '‚öôÔ∏è x2', retreat: '‚≠ê ‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/282.png' },
      togepi: { stage: 'BASIC', evolvesFrom: '', hp: '50', type: '#f0f0f0', stats: "NO. 175 Spike Ball Pok√©mon HT: 1'0\" WT: 3.3 lbs.", abilityName: 'Joyful Gift', abilityDescription: 'Once during your turn, you may heal 10 damage from one of your Benched Pok√©mon.', attackName: 'Charm', attackDamage: '10', attackDescription: "During your opponent's next turn, the Defending Pok√©mon's attacks do 20 less damage.", weakness: '‚öôÔ∏è x2', retreat: '‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/175.png' },
      jigglypuff: { stage: 'BASIC', evolvesFrom: '', hp: '70', type: '#f8b8f8', stats: "NO. 039 Balloon Pok√©mon HT: 1'8\" WT: 12.1 lbs.", abilityName: 'Lullaby', abilityDescription: 'The Defending Pok√©mon is now Asleep.', attackName: 'Pound', attackDamage: '20', attackDescription: '', weakness: 'üêæ x2', retreat: '‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/39.png' },
      vulpix: { stage: 'BASIC', evolvesFrom: '', hp: '60', type: '#ee8130', stats: "NO. 037 Fox Pok√©mon HT: 2'0\" WT: 21.8 lbs.", abilityName: 'Roar', abilityDescription: "Your opponent switches their Active Pok√©mon with 1 of their Benched Pok√©mon.", attackName: 'Ember', attackDamage: '30', attackDescription: 'Discard a Fire Energy from this Pok√©mon.', weakness: 'üíß x2', retreat: '‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/37.png' },
      squirtle: { stage: 'BASIC', evolvesFrom: '', hp: '60', type: '#6890f0', stats: "NO. 007 Tiny Turtle Pok√©mon HT: 1'8\" WT: 19.8 lbs.", abilityName: 'Shell Armor', abilityDescription: 'Prevent all damage done to this Pok√©mon by attacks if it is on the Bench.', attackName: 'Water Gun', attackDamage: '20', attackDescription: '', weakness: 'üåø x2', retreat: '‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/7.png' },
      piplup: { stage: 'BASIC', evolvesFrom: '', hp: '60', type: '#78c8f0', stats: "NO. 393 Penguin Pok√©mon HT: 1'4\" WT: 11.5 lbs.", abilityName: 'Bubble', abilityDescription: 'Flip a coin. If heads, the Defending Pok√©mon is now Paralyzed.', attackName: 'Peck', attackDamage: '10', attackDescription: '', weakness: '‚ö° x2', retreat: '‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/393.png' },
      psyduck: { stage: 'BASIC', evolvesFrom: '', hp: '70', type: '#f8d030', stats: "NO. 054 Duck Pok√©mon HT: 2'7\" WT: 43.2 lbs.", abilityName: 'Headache', abilityDescription: "This Pok√©mon can't attack if you have 3 or more cards in your hand.", attackName: 'Scratch', attackDamage: '50', attackDescription: '', weakness: '‚ö° x2', retreat: '‚≠ê', img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/54.png' }
    };

    /* ============= STATE ============= */
    let current = -1;
    let answers = [];
    let userName = "";

    /* ============= DOM ============= */
    const dialogEl = document.getElementById('dialog');
    const optionsEl = document.getElementById('options');
    const previewImg = document.getElementById('preview-img');
    const statusEl = document.getElementById('status');
    const quizContentEl = document.getElementById('quiz-content');
    const holoCardContainerEl = document.getElementById('holo-card-container');
    const pokemonCardEl = document.getElementById('pokemon-card');

    /* ============= TYPING EFFECT ============= */
    function typeText(text, cb) {
      dialogEl.innerHTML = '';
      let i = 0;
      const span = document.createElement('span');
      dialogEl.appendChild(span);
      const caret = document.createElement('span');
      caret.className = 'typing';
      dialogEl.appendChild(caret);

      const speed = 18;
      function step() {
        if (i <= text.length) {
          span.textContent = text.slice(0, i);
          i++;
          setTimeout(step, speed);
        } else {
          caret.remove();
          if (cb) cb();
        }
      }
      step();
    }

    /* ============= NAME INPUT SCREEN ============= */
    function showNameInput() {
      typeText("Welcome to the Pok√©mon Personality Quiz! What's your name, trainer?", () => { });

      optionsEl.innerHTML = '';
      const nameInput = document.createElement('input');
      nameInput.className = 'name-input';
      nameInput.type = 'text';
      nameInput.placeholder = 'Enter your name';
      nameInput.maxLength = 15;

      const startBtn = document.createElement('button');
      startBtn.className = 'option-btn';
      startBtn.textContent = 'Start Quiz';
      startBtn.onclick = () => {
        const name = nameInput.value.trim();
        if (name) {
          playSelectSound();
          userName = name;
          current = 0;
          setTimeout(loadQuestion, 300);
        } else {
          nameInput.style.borderColor = '#ff4444';
          setTimeout(() => nameInput.style.borderColor = 'var(--gc-silver)', 1000);
        }
      };

      nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') startBtn.click(); });

      optionsEl.appendChild(nameInput);
      optionsEl.appendChild(startBtn);

      setTimeout(() => nameInput.focus(), 100);
      statusEl.textContent = "Enter your trainer name";
    }

    /* ============= LOAD / SHOW QUESTION ============= */
    function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]] } return a }

    function loadQuestion() {
      const q = quizQuestions[current];
      typeText(q.question, () => { });
      optionsEl.innerHTML = '';
      const opts = shuffle([...q.options]);
      opts.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt;
        btn.onclick = () => {
          playSelectSound();
          selectAnswer(opt);
        };
        optionsEl.appendChild(btn);
      });
      previewImg.src = getPreviewForQuestion(current);
      statusEl.textContent = `Question ${current + 1} / ${quizQuestions.length}`;
    }

    function getPreviewForQuestion(index) {
      const pool = ['pikachu', 'togepi', 'vulpix', 'squirtle', 'piplup', 'jigglypuff', 'psyduck', 'charizard', 'blastoise', 'venusaur', 'alakazam', 'onix', 'umbreon', 'gardevoir', 'articuno'];
      return `https://play.pokemonshowdown.com/sprites/ani/${pool[index % pool.length]}.gif`;
    }

    function selectAnswer(option) {
      answers.push(option);
      previewImg.style.transform = 'scale(0.94)';
      setTimeout(() => previewImg.style.transform = '', 140);
      current++;
      if (current < quizQuestions.length) {
        setTimeout(loadQuestion, 220);
      } else {
        setTimeout(showResult, 300);
      }
    }

    /* ============= POK√©MON SCORING (original logic) ============= */
    function getPokemon(answers) {
      const points = { charizard: 0, blastoise: 0, venusaur: 0, pikachu: 0, alakazam: 0, articuno: 0, onix: 0, umbreon: 0, gardevoir: 0, togepi: 0, jigglypuff: 0, vulpix: 0, squirtle: 0, piplup: 0, psyduck: 0 };
      answers.forEach(ans => {
        if (["Neon", "Coffee", "Sunny", "Fast", "Rock", "Summer", "Pok√©ball", "Red", "Orange", "Spicy", "Mountains", "Action", "Dragon", "Warrior", "Sprint", "Bonfire", "Volcano", "Guitar", "Phoenix"].includes(ans)) { points.charizard++; if (["Orange", "Red", "Volcano", "Bonfire", "Guitar", "Phoenix"].includes(ans)) points.vulpix++; }
        if (["Pastel", "Matcha", "Rainy", "Calm", "Jazz", "Monsoon", "Potion", "Blue", "Aqua", "Mild", "Ocean", "Swimming", "Piano", "Waterfall", "Dolphin", "Mermaid", "Healer", "Meditation", "Lake"].includes(ans)) { points.blastoise++; if (["Ocean", "Swimming", "Summer", "Blue", "Dolphin"].includes(ans)) points.squirtle++; if (["Aqua", "Mild", "Skyline", "Piplup", "Monsoon"].includes(ans)) points.piplup++; }
        if (["Earthy", "Tea", "Cloudy", "Fruit", "Steady", "Ambient", "Spring", "Forest", "Green", "Brown", "Sweet", "Meadow", "Hiking", "Flute", "Garden", "Fairy", "Guardian", "Yoga", "Greenhouse"].includes(ans)) { points.venusaur++; if (["Pastal", "Sweet", "Flute", "Fairy", "Meadow", "Lake"].includes(ans)) points.togepi++; }
        if (["Dark tones", "Juice", "Snowy", "Chocolate", "Unpredictable", "Pop", "Winter", "City", "Rare Candy", "Master Ball", "Yellow", "Purple", "Sour", "Skyline", "Gaming", "Synthesizer", "Lightning", "Tiger", "Robot", "Inventor", "Parkour", "Laboratory", "Arcade", "Caf√©"].includes(ans)) { points.pikachu++; if (["Pop", "Piano", "Synthesizer", "Purple", "Chocolate", "City"].includes(ans)) points.jigglypuff++; if (["Unpredictable", "Cloudy", "Snowy", "Laboratory", "Robot", "Juice", "Arcade"].includes(ans)) points.psyduck++; }
        if (["Meditation", "Piano", "Flute", "Synthesizer", "Inventor", "Healer", "Guardian", "Fairy"].includes(ans)) { points.alakazam++; if (["Fairy", "Guardian", "Healer", "Garden"].includes(ans)) points.gardevoir++; }
        if (["Snowy", "Winter", "Lake"].includes(ans)) { points.articuno++; }
        if (["Mountains", "Rock", "Volcano", "Hiking", "Sprint"].includes(ans)) { points.onix++; }
        if (["Dark tones", "Night", "Robot", "Tiger", "Unpredictable"].includes(ans)) { points.umbreon++; }
        if (["Orange", "Red", "Bonfire", "Volcano", "Guitar", "Phoenix", "Action"].includes(ans)) { points.vulpix++; }
        if (["Gaming", "Rare Candy", "City", "Arcade"].includes(ans)) { points.squirtle++; points.piplup++; }
        if (["Sweet", "Fairy", "Flute"].includes(ans)) points.togepi++;
        if (["Pop", "Piano", "Purple"].includes(ans)) points.jigglypuff++;
        if (["Cloudy", "Unpredictable", "Juice"].includes(ans)) points.psyduck++;
      });
      const priority = ["charizard", "blastoise", "venusaur", "pikachu", "togepi", "jigglypuff", "vulpix", "squirtle", "piplup", "psyduck", "alakazam", "gardevoir", "onix", "umbreon", "articuno"];
      let best = priority[0];
      priority.forEach(p => { if (points[p] > points[best]) best = p; });
      return best;
    }

    /* ============= RESULT / UI ============= */
    function showResult() {
      const pokemonKey = getPokemon(answers);
      const prettyName = pokemonKey.charAt(0).toUpperCase() + pokemonKey.slice(1);

      dialogEl.innerHTML = '';
      optionsEl.innerHTML = '';

      const rs = document.createElement('div');
      rs.className = 'result-screen';

      const card = document.createElement('div');
      card.className = 'result-card';
      card.innerHTML = `
    <div class="trainer-name">Trainer ${userName}</div>
    <div class="pokemon-name">Your Pok√©mon is: ${prettyName}!</div>
    <img src="https://play.pokemonshowdown.com/sprites/ani/${pokemonKey}.gif" alt="${prettyName}" style="max-width:200px; image-rendering:pixelated;">
    <div class="muted">${getPersonalityBlurb(pokemonKey)}</div>
  `;

      const buttonsContainer = document.createElement('div');
      buttonsContainer.className = 'result-buttons';

      const previewBtn = document.createElement('button');
      previewBtn.className = 'restart'; // reuse style
      previewBtn.textContent = 'Preview Holo Card';
      previewBtn.onclick = () => {
        playSelectSound();
        previewHoloCard(pokemonKey, userName);
      };

      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'restart';
      downloadBtn.textContent = 'Download Holo Card (PNG)';
      downloadBtn.onclick = () => {
        playSelectSound();
        downloadHoloCard(pokemonKey, userName);
      };

      const restartBtn = document.createElement('button');
      restartBtn.className = 'restart';
      restartBtn.textContent = 'Take Quiz Again';
      restartBtn.onclick = () => { playSelectSound(); resetQuiz(); };

      buttonsContainer.appendChild(previewBtn);
      buttonsContainer.appendChild(downloadBtn);
      buttonsContainer.appendChild(restartBtn);

      rs.appendChild(card);
      rs.appendChild(buttonsContainer);
      optionsEl.appendChild(rs);

      setTimeout(() => playVictorySound(), 500);
      previewImg.src = `https://play.pokemonshowdown.com/sprites/ani/${pokemonKey}.gif`;
      statusEl.textContent = `Result: ${prettyName}`;
    }

    /* ============= HOLO CARD FUNCTIONS ============= */

    function populateHoloCard(pokemonKey, trainerName, cardEl = pokemonCardEl) {
      const details = pokemonDetails[pokemonKey];
      if (!details) return;

      // Use querySelector on the provided element to avoid conflicts with cloned nodes
      cardEl.querySelector('#card-stage-info').innerHTML = `${details.stage} <span class="evolves-from">${details.evolvesFrom}</span>`;
      cardEl.querySelector('#card-hp').textContent = details.hp;
      cardEl.querySelector('#card-energy-symbol').style.backgroundColor = details.type;
      cardEl.querySelector('#card-image-container').style.backgroundImage = `url('${details.img}')`;
      cardEl.querySelector('#card-stats-bar').textContent = details.stats;
      cardEl.querySelector('#card-ability-name').textContent = details.abilityName;
      cardEl.querySelector('#card-ability-description').textContent = details.abilityDescription;
      cardEl.querySelector('#card-attack-name').textContent = details.attackName;
      cardEl.querySelector('#card-attack-damage').textContent = details.attackDamage;
      cardEl.querySelector('#card-attack-description').textContent = details.attackDescription;
      cardEl.querySelector('#card-weakness').textContent = details.weakness;
      cardEl.querySelector('#card-retreat').textContent = details.retreat;
    }

    function previewHoloCard(pokemonKey, userName) {
      quizContentEl.style.display = 'none';
      holoCardContainerEl.style.display = 'flex';

      populateHoloCard(pokemonKey, userName, pokemonCardEl);

      // Enable interactive effects
      const cardInner = pokemonCardEl.querySelector('.card-inner');
      const imageContainer = pokemonCardEl.querySelector('.image-container');
      cardInner.classList.add('interactive');
      imageContainer.classList.add('interactive');

      // Attach mouse move listeners for interactive effect
      pokemonCardEl.addEventListener('mousemove', handleCardMouseMove);
      pokemonCardEl.addEventListener('mouseleave', handleCardMouseLeave);
    }

    document.getElementById('back-to-result').onclick = () => {
      playSelectSound();
      holoCardContainerEl.style.display = 'none';
      quizContentEl.style.display = 'block';

      // Clean up listeners and interactive classes
      pokemonCardEl.removeEventListener('mousemove', handleCardMouseMove);
      pokemonCardEl.removeEventListener('mouseleave', handleCardMouseLeave);
      pokemonCardEl.style.transform = ''; // Reset transform

      const cardInner = pokemonCardEl.querySelector('.card-inner');
      const imageContainer = pokemonCardEl.querySelector('.image-container');
      cardInner.classList.remove('interactive');
      imageContainer.classList.remove('interactive');
    };

    function handleCardMouseMove(e) {
      const rect = pokemonCardEl.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      const rotateX = (y - centerY) / 20;
      const rotateY = (centerX - x) / 20;
      pokemonCardEl.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;

      // Ensure valid values for CSS custom properties (clamp between 0 and 1)
      const mx = Math.max(0, Math.min(1, isFinite(x / rect.width) ? x / rect.width : 0.5));
      const my = Math.max(0, Math.min(1, isFinite(y / rect.height) ? y / rect.height : 0.5));
      pokemonCardEl.style.setProperty('--mx', mx.toString());
      pokemonCardEl.style.setProperty('--my', my.toString());
    }

    function handleCardMouseLeave() {
      pokemonCardEl.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg)';
    }

    async function downloadHoloCard(pokemonKey, userName) {
      // Create a clone of the card to render off-screen, avoiding modification of the live element.
      const cardToRender = pokemonCardEl.cloneNode(true);
      cardToRender.id = 'pokemon-card-for-render'; // Avoid duplicate IDs in the DOM

      // Populate the clone with the correct data.
      populateHoloCard(pokemonKey, userName, cardToRender);

      // Style the clone for a static, clean capture.
      cardToRender.style.transform = 'none';
      cardToRender.style.position = 'absolute';
      cardToRender.style.left = '-9999px'; // Position it off-screen
      cardToRender.style.top = '0';

      const cardInner = cardToRender.querySelector('.card-inner');
      const imageContainer = cardToRender.querySelector('.image-container');

      // Remove interactive classes and add the static capturing class.
      cardInner.classList.remove('interactive');
      imageContainer.classList.remove('interactive');
      cardInner.classList.add('is-capturing');

      // Add the clone to the document body for rendering.
      document.body.appendChild(cardToRender);

      // Allow a moment for the browser to render the off-screen element.
      setTimeout(() => {
        html2canvas(cardToRender, {
          scale: 2,
          useCORS: true,
          backgroundColor: null,
          allowTaint: true, // Necessary for cross-origin images
        }).then(canvas => {
          const link = document.createElement('a');
          const safeName = (userName || 'trainer').replace(/[^a-z0-9_-]/gi, '_');
          link.download = `${safeName}_${pokemonKey}_card.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
          link.remove();
        }).catch(err => {
          console.error("Oops, could not create card image!", err);
          alert('Sorry ‚Äî could not generate the PNG. This may be a browser-specific issue with canvas rendering.');
        }).finally(() => {
          // --- CLEAN UP AFTER CAPTURE ---
          // Remove the off-screen clone from the document.
          document.body.removeChild(cardToRender);
        });
      }, 300); // A generous delay to ensure rendering is complete.
    }

    /* ============= SHORT BLURB PER POK√©MON ============= */
    function getPersonalityBlurb(key) {
      const blurbs = {
        charizard: "Fiery and adventurous ‚Äî you take charge and love action.",
        blastoise: "Steady and loyal ‚Äî calm under pressure and dependable.",
        venusaur: "Grounded and nurturing ‚Äî connected to nature and steady growth.",
        pikachu: "Energetic and playful ‚Äî sparks fly where you go.",
        togepi: "Sweet-hearted and wholesome ‚Äî you brighten small moments.",
        jigglypuff: "Creative and dramatic ‚Äî you love to perform and charm.",
        vulpix: "Graceful and warm ‚Äî elegance with a spark of mischief.",
        squirtle: "Cool and playful ‚Äî easygoing with a cheeky streak.",
        piplup: "Proud and stylish ‚Äî confident with a soft heart.",
        psyduck: "Quirky and unpredictable ‚Äî delightfully confusing at times.",
        alakazam: "Insightful and clever ‚Äî your mind solves puzzles others can't.",
        gardevoir: "Protective and empathetic ‚Äî you feel deeply and care for others.",
        onix: "Sturdy and resilient ‚Äî strong, reliable, and unshakable.",
        umbreon: "Mysterious and composed ‚Äî calm, cool, and quietly powerful.",
        articuno: "Calm and majestic ‚Äî cool-headed with a serene presence."
      };
      return blurbs[key] || "A unique spirit ‚Äî this Pok√©mon matches your vibe!";
    }

    /* ============= RESET ============= */
    function resetQuiz() {
      current = -1;
      answers = [];
      userName = "";

      quizContentEl.style.display = 'block';
      holoCardContainerEl.style.display = 'none';
      dialogEl.innerHTML = '';
      optionsEl.innerHTML = '';

      previewImg.src = 'https://play.pokemonshowdown.com/sprites/ani/pikachu.gif';
      statusEl.textContent = 'Welcome, trainer!';

      setTimeout(() => { showNameInput(); }, 100);
    }

    /* ============= RETRO SOUND EFFECTS ============= */
    let audioContext = null;
    function initAudio() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); }

    function playSelectSound() {
      initAudio();
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.frequency.setValueAtTime(800, audioContext.currentTime);
      osc.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
      gain.gain.setValueAtTime(0.3, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
      osc.type = 'square';
      osc.start();
      osc.stop(audioContext.currentTime + 0.15);
    }

    function playVictorySound() {
      initAudio();
      const melody = [
        { freq: 523.25, time: 0 }, { freq: 659.25, time: 0.15 }, { freq: 783.99, time: 0.3 },
        { freq: 1046.5, time: 0.45 }, { freq: 783.99, time: 0.6 }, { freq: 1046.5, time: 0.75 },
        { freq: 1318.5, time: 0.9 }, { freq: 1046.5, time: 1.05 }
      ];
      melody.forEach(note => {
        setTimeout(() => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.connect(gain);
          gain.connect(audioContext.destination);
          osc.frequency.setValueAtTime(note.freq, audioContext.currentTime);
          osc.type = 'square';
          gain.gain.setValueAtTime(0, audioContext.currentTime);
          gain.gain.linearRampToValueAtTime(0.25, audioContext.currentTime + 0.01);
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.12);
          osc.start();
          osc.stop(audioContext.currentTime + 0.12);
        }, note.time * 1000);
      });
    }

    /* ============= START ============= */
    showNameInput();
  </script>
</body>

</html>
